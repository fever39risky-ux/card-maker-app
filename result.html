<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒã‚±ã‚«é¢¨ã‚µãƒãƒ¼ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼ (çµæœ)</title>
    <style>
        @font-face {
            font-family: 'Mplus1-Bold';
            src: url('fonts/Mplus1-Bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        body {
            font-family: sans-serif;
            text-align: center;
            margin-top: 50px;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 { color: #333; }
        #cardCanvas {
            border: 1px solid #ddd;
            background-color: #eee;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        #downloadLink {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 1.1em;
            display: inline-block;
        }
        #shareButton {
            background-color: #000;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1.1em;
            margin-top: 15px;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body onload="drawResultCard()">

<div class="container">
    <h1>âœ… å®Œæˆï¼âœ¨</h1>
    <p>ç”»åƒã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‹ã‚‰ä¿å­˜ãŒã§ãã¾ã™ã€‚</p>
    <p>Xã«ãƒã‚¹ãƒˆã—ã¦ã¿ã‚“ãªã«è¦‹ã¦ã‚‚ã‚‰ãŠã†ï¼ï¼</p>

    <canvas id="cardCanvas"></canvas>
    <a id="downloadLink" href="#" download="my_original_card.png">ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>

    <button id="shareButton" type="button">
        <svg viewBox="0 0 24 24" aria-hidden="true"
             style="fill: white; height: 1.2em; width: 1.2em; vertical-align: middle; margin-right: 5px;">
            <g><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.717 6.231zm-1.164 16.597h1.408L7.096 3.99H5.5L17.08 18.847z"></path></g>
        </svg>
        Xã§ã‚·ã‚§ã‚¢ï¼
    </button>

    <p style="margin-top: 30px;">
        <a href="#" onclick="clearAndGoBack()">â† æˆ»ã£ã¦ä½œã‚Šç›´ã™</a>
    </p>
</div>

<script src="effects.js"></script>

<script>
    const cardCanvas   = document.getElementById('cardCanvas');
    const ctx          = cardCanvas.getContext('2d');
    const downloadLink = document.getElementById('downloadLink');
    const shareButton  = document.getElementById('shareButton');

    // âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚«ãƒ¼ãƒ‰åã‚’æŒãŸã›ã‚‹ï¼ˆæŠ•ç¨¿æ–‡ã§ã‚‚ä½¿ã†ï¼‰
    let cardName      = null;   // åŠ å·¥å¾Œï¼ˆâ—‹â—‹ã®â–³â–³ï¼‰
    let originalName  = null;   // åŠ å·¥å‰
    let randomEffectText = '';  // åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚·ã‚§ã‚¢æ–‡ã«ã‚‚ä½¿ã†ï¼‰

    const TEMPLATE_PATH = 'card_template/card_template.png';

    const profileImageX      = 69;
    const profileImageY      = 173;
    const profileImageWidth  = 730;
    const profileImageHeight = 455;

    const NAME_Y = 145;

    const EFFECT_X           = 80;
    const EFFECT_Y_START     = 750;
    const EFFECT_MAX_WIDTH   = 720;
    const EFFECT_LINE_HEIGHT = 36;

    let cardBaseImage = new Image();

    // â‘  çµæœç”»é¢ã‚’æç”»é–‹å§‹
    function drawResultCard() {
        cardName     = sessionStorage.getItem('cardName');
        originalName = sessionStorage.getItem('originalName') || cardName;
        const imageDataURL = sessionStorage.getItem('imageDataURL');

        if (!cardName || !imageDataURL) {
            alert("ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…¥åŠ›ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚");
            window.location.href = 'index.html';
            return;
        }

        const uploadedProfileImage = new Image();
        uploadedProfileImage.onload = () => {
            cardBaseImage.onload = () => {
                cardCanvas.width  = cardBaseImage.width;
                cardCanvas.height = cardBaseImage.height;
                renderCard(uploadedProfileImage);
            };
            cardBaseImage.src = TEMPLATE_PATH;
        };
        uploadedProfileImage.src = imageDataURL;
    }

    // â‘¡ ã‚«ãƒ¼ãƒ‰ã‚’æç”»ã—ã€ã‚µãƒ¼ãƒãƒ¼ã«ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ & ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³è¨­å®š
    function renderCard(uploadedProfileImage) {
        ctx.clearRect(0, 0, cardCanvas.width, cardCanvas.height);
        ctx.drawImage(cardBaseImage, 0, 0, cardCanvas.width, cardBaseImage.height);

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ
        ctx.drawImage(
            uploadedProfileImage,
            profileImageX,
            profileImageY,
            profileImageWidth,
            profileImageHeight
        );

        // ã‚«ãƒ¼ãƒ‰å
        if (cardName && cardName.trim() !== "") {
            ctx.fillStyle = '#000';
            ctx.font = 'bold 48px "Mplus1-Bold", sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(cardName, 80, NAME_Y);
        }

        // ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆ
        // ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆ
const randomIndex      = Math.floor(Math.random() * EFFECT_PATTERNS.length);
const randomEffectText = EFFECT_PATTERNS[randomIndex];

// âœ¨ è‡ªå‹•ã§æ–‡å­—ã‚µã‚¤ã‚ºã‚’èª¿æ•´ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ 
const baseFontSize = 18; // æœ€åˆã®æ–‡å­—ã‚µã‚¤ã‚º
const maxEffectHeight = 160; // åŠ¹æœæ¬„ã®é«˜ã•ï¼ˆå®Ÿéš›ã®è¦‹ãŸç›®ã«åˆã‚ã›ã¦èª¿æ•´å¯ï¼‰
const adjustedFontSize = adjustFontSizeToFit(
    ctx,
    randomEffectText,
    EFFECT_MAX_WIDTH,
    maxEffectHeight,
    baseFontSize
);

ctx.fillStyle = '#000';
ctx.font      = `${adjustedFontSize}px sans-serif`; // â†èª¿æ•´å¾Œã®æ–‡å­—ã‚µã‚¤ã‚ºã‚’åæ˜ 
ctx.textAlign = 'left';

// ğŸ¯ wrapTextã§æç”»å®Ÿè¡Œ
wrapText(
    ctx,
    randomEffectText,
    EFFECT_X,
    EFFECT_Y_START,
    EFFECT_MAX_WIDTH,
    EFFECT_LINE_HEIGHT
);


        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯æ›´æ–°
        const dataURL = cardCanvas.toDataURL('image/png');
        downloadLink.href = dataURL;

        // ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ç”»åƒURLã‚’å–å¾— â†’ ãã®å¾Œã§ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã‚’è¨­å®š
        uploadImageToServer(dataURL)
            .then(imageUrl => {
                console.log('Uploaded image URL:', imageUrl);
                setupShareButton(imageUrl);
            })
            .catch(err => {
                console.error('Upload failed:', err);
                setupShareButton(null); // å¤±æ•—ã—ã¦ã‚‚ãƒ†ã‚­ã‚¹ãƒˆã ã‘ã‚·ã‚§ã‚¢
            });
    }

    // â‘¢ ConoHa ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ç”»åƒURLã‚’è¿”ã™
    async function uploadImageToServer(dataURL) {
        const response = await fetch('https://gun-lido.com/cards/upload_card.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: dataURL })
        });
        const result = await response.json();
        console.log("ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœ:", result);

        if (result.url) {
            return result.url;
        } else {
            throw new Error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: URLæœªè¿”å´');
        }
    }

    // â‘£ XæŠ•ç¨¿ãƒœã‚¿ãƒ³ã®æŒ™å‹•
    function setupShareButton(imageUrl) {
        shareButton.onclick = () => {
            const appURL = 'https://fever39risky-ux.github.io/card-maker-app/';

            const shareText =
                `ğŸ‰ ãƒã‚±ã‚«é¢¨ã®ã‚µãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ãŒç°¡å˜ã«ä½œã‚Œã¡ã‚ƒã†ï¼ï¼\n` +
                `${originalName}ã•ã‚“ãŒã‚µãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ã«ãªã£ãŸã‚‰ï¼Ÿ\n\n` +
                `ã€ ã‚«ãƒ¼ãƒ‰å: ${cardName} ã€\n` +
                (imageUrl ? `ğŸ–¼ ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’ã¿ã¦ã¿ã‚‹ğŸ‘‡\n${imageUrl}\n\n` : ``) +
                `#ãƒã‚±ã‚«é¢¨ã‚µãƒãƒ¼ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼`;

            const twitterUrl =
                `https://x.com/intent/post?text=${encodeURIComponent(shareText)}`;

            window.open(twitterUrl, '_blank', 'noopener');
        };
    }

    // ğŸ”½ åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆã®æ–‡å­—ã‚µã‚¤ã‚ºã‚’è‡ªå‹•èª¿æ•´ã™ã‚‹é–¢æ•°
function adjustFontSizeToFit(ctx, text, maxWidth, maxHeight, baseFontSize) {
    let fontSize = baseFontSize;

    ctx.font = `${fontSize}px sans-serif`;
    const lines = wrapTextToLines(ctx, text, maxWidth);

    while ((lines.length * (fontSize + 4)) > maxHeight && fontSize > 10) {
        fontSize -= 2;
        ctx.font = `${fontSize}px sans-serif`;
    }
    return fontSize;
}

// ğŸ”½ wrapTextToLinesé–¢æ•° -- æ”¹è¡Œå‰æã§è¡Œé…åˆ—ã«åˆ†å‰²
function wrapTextToLines(ctx, text, maxWidth) {
    const words = text.split('');
    let lines = [];
    let line = '';

    for (let i = 0; i < words.length; i++) {
        let testLine = line + words[i];
        if (ctx.measureText(testLine).width > maxWidth && i > 0) {
            lines.push(line);
            line = words[i];
        } else {
            line = testLine;
        }
    }
    lines.push(line);
    return lines;
}


    // ãƒ†ã‚­ã‚¹ãƒˆè‡ªå‹•æ”¹è¡Œ
    function wrapText(context, text, x, y, maxWidth, lineHeight) {
        const chars = text.split('');
        let line = '';
        let currentY = y;

        for (let i = 0; i < chars.length; i++) {
            const char = chars[i];

            if (char === '\n') {
                context.fillText(line, x, currentY);
                line = '';
                currentY += lineHeight;
                continue;
            }

            const testLine = line + char;
            const testWidth = context.measureText(testLine).width;

            if (testWidth > maxWidth) {
                context.fillText(line, x, currentY);
                line = char;
                currentY += lineHeight;
            } else {
                line = testLine;
            }
        }
        context.fillText(line, x, currentY);
    }

    function clearAndGoBack() {
        sessionStorage.removeItem('cardName');
        sessionStorage.removeItem('originalName');
        sessionStorage.removeItem('imageDataURL');
        window.location.href = 'index.html';
    }
</script>

</body>
</html>







