<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒã‚±ã‚«é¢¨ã‚µãƒãƒ¼ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼ (çµæœ)</title>
    <style>
        /* ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€è¨­å®š (card_maker.htmlã¨åŒã˜) */
        @font-face {
            font-family: 'Mplus1-Bold';
            src: url('fonts/Mplus1-Bold.otf') format('opentype');
            font-weight: bold;
            font-style: normal;
        }

        body {
            font-family: sans-serif;
            text-align: center;
            margin-top: 50px;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1 { color: #333; }
        #cardCanvas {
            border: 1px solid #ddd;
            background-color: #eee;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        #downloadLink {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 1.1em;
            display: inline-block;
        }
    </style>
</head>
<body onload="drawResultCard()">

<div class="container">
    <h1>âœ… å®Œæˆï¼âœ¨</h1>
    <p>ç”»åƒã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‹ã‚‰ä¿å­˜ãŒã§ãã¾ã™ã€‚</p>
    <p>Xã«ãƒã‚¹ãƒˆã—ã¦ã¿ã‚“ãªã«è¦‹ã¦ã‚‚ã‚‰ãŠã†ï¼ï¼</p>

    <canvas id="cardCanvas"></canvas>
    <a id="downloadLink" href="#" download="my_original_card.png">ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>

    <button id="shareButton" type="button" style="
        background-color: #000;
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 1.1em;
        margin-top: 15px;
        border: none;
        cursor: pointer;
    ">
        <svg viewBox="0 0 24 24" aria-hidden="true" style="fill: white; height: 1.2em; width: 1.2em; vertical-align: middle; margin-right: 5px;">
            <g><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.717 6.231zm-1.164 16.597h1.408L7.096 3.99H5.5L17.08 18.847z"></path></g>
        </svg>
        ã§ã‚·ã‚§ã‚¢ï¼
    </button>

    <p style="margin-top: 30px;">
        <a href="#" onclick="clearAndGoBack()">â† æˆ»ã£ã¦ä½œã‚Šç›´ã™</a>
    </p>
</div>

<script>
    const cardCanvas   = document.getElementById('cardCanvas');
    const ctx          = cardCanvas.getContext('2d');
    const downloadLink = document.getElementById('downloadLink');
    const shareButton  = document.getElementById('shareButton');

    // â˜… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã®ãƒ‘ã‚¹ï¼ˆresult.html ã¨åŒã˜éšå±¤ã« card_template ãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚‹æƒ³å®šï¼‰
    const TEMPLATE_PATH = 'card_template/card_template.png';

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’åˆæˆã™ã‚‹ä½ç½®ã¨ã‚µã‚¤ã‚º
    const profileImageX      = 69;
    const profileImageY      = 173;
    const profileImageWidth  = 730;
    const profileImageHeight = 455;

    // ã‚«ãƒ¼ãƒ‰åæç”»è¨­å®š
    const NAME_Y = 145;

    // åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆã®æç”»è¨­å®š
    const EFFECT_X          = 80;
    const EFFECT_Y_START    = 750;
    const EFFECT_MAX_WIDTH  = 720;
    const EFFECT_LINE_HEIGHT = 22;

    // ãƒ©ãƒ³ãƒ€ãƒ ã«æŠ½å‡ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³
    const EFFECT_PATTERNS = [
        "è‡ªåˆ†ã®æ‰‹æœ­ã‚’ã™ã¹ã¦å±±æœ­ã«ã‚‚ã©ã—ã¦åˆ‡ã‚‹ã€‚\nãã®å¾Œã€å±±æœ­ã‚’6æšå¼•ãã€‚è‡ªåˆ†ã®ã‚µã‚¤ãƒ‰ã®æ®‹ã‚Šæšæ•°ãŒ6æšãªã‚‰ã€å¼•ãæšæ•°ã¯8æšã«ãªã‚‹ã€‚",
        "è‡ªåˆ†ã®å±±æœ­ã‹ã‚‰ã€ŒãŸã­ãƒã‚±ãƒ¢ãƒ³ã€ã€Œ1é€²åŒ–ãƒã‚±ãƒ¢ãƒ³ã€ã€Œ2é€²åŒ–ãƒã‚±ãƒ¢ãƒ³ã€ã‚’1æšãšã¤é¸ã³ã€ç›¸æ‰‹ã«è¦‹ã›ã¦ã€æ‰‹æœ­ã«åŠ ãˆã‚‹ã€‚\nãã—ã¦å±±æœ­ã‚’åˆ‡ã‚‹ã€‚",
        "ç›¸æ‰‹ã®ãƒ™ãƒ³ãƒãƒã‚±ãƒ¢ãƒ³ã‚’1åŒ¹é¸ã³ã€ãƒãƒˆãƒ«ãƒã‚±ãƒ¢ãƒ³ã¨å…¥ã‚Œæ›¿ãˆã‚‹ã€‚",
        "ã“ã®ã‚«ãƒ¼ãƒ‰ã¯ã€è‡ªåˆ†ã®æ‰‹æœ­ã‚’1æšãƒˆãƒ©ãƒƒã‚·ãƒ¥ã—ãªã‘ã‚Œã°ä½¿ãˆãªã„ã€‚\nè‡ªåˆ†ã®æ‰‹æœ­ãŒ6æšã«ãªã‚‹ã‚ˆã†ã«ã€å±±æœ­ã‚’å¼•ãã€‚",
        "è‡ªåˆ†ã®å±±æœ­ã‹ã‚‰é€²åŒ–ãƒã‚±ãƒ¢ãƒ³ã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’1æšãšã¤é¸ã³ã€ç›¸æ‰‹ã«è¦‹ã›ã¦ã€æ‰‹æœ­ã«åŠ ãˆã‚‹ã€‚\nãã—ã¦å±±æœ­ã‚’åˆ‡ã‚‹ã€‚",
        "è‡ªåˆ†ã®æ‰‹æœ­ã‚’ã™ã¹ã¦ãƒˆãƒ©ãƒƒã‚·ãƒ¥ã—ã€å±±æœ­ã‚’7æšå¼•ãã€‚",
        "è‡ªåˆ†ã®ãƒã‚±ãƒ¢ãƒ³å…¨å“¡ã®HPã‚’ã€ãã‚Œãã‚Œã€Œ40ã€å›å¾©ã™ã‚‹ã€‚",
        "è‡ªåˆ†ã®å±±æœ­ã‚’3æšå¼•ãã€‚",
        "ãŠãŸãŒã„ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã€ãã‚Œãã‚Œè‡ªåˆ†ã®æ‰‹æœ­ã‚’ã™ã¹ã¦ã‚¦ãƒ©ã«ã—ã¦åˆ‡ã‚Šã€å±±æœ­ã®ä¸‹ã«ã‚‚ã©ã™ã€‚\nãã®å¾Œã€ãã‚Œãã‚Œè‡ªåˆ†ã®ã‚µã‚¤ãƒ‰ã®æ®‹ã‚Šæšæ•°ã¶ã‚“ã€å±±æœ­ã‚’å¼•ãã€‚",
        "è‡ªåˆ†ã®å±±æœ­ã‹ã‚‰ã€Œã‚°ãƒƒã‚ºã€ã¨ã€Œãƒã‚±ãƒ¢ãƒ³ã®ã©ã†ãã€ã‚’1æšãšã¤é¸ã³ã€ç›¸æ‰‹ã«è¦‹ã›ã¦ã€æ‰‹æœ­ã«åŠ ãˆã‚‹ã€‚\nãã—ã¦å±±æœ­ã‚’åˆ‡ã‚‹ã€‚",
        "è‡ªåˆ†ã®ãƒ™ãƒ³ãƒãƒã‚±ãƒ¢ãƒ³ã«ã¤ã„ã¦ã„ã‚‹ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’2å€‹ã¾ã§é¸ã³ã€ãƒãƒˆãƒ«ãƒã‚±ãƒ¢ãƒ³ã«ã¤ã‘æ›¿ãˆã‚‹ã€‚",
        "è‡ªåˆ†ã®å±±æœ­ã‹ã‚‰ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚ºã‚’1æšé¸ã³ã€ç›¸æ‰‹ã«è¦‹ã›ã¦ã€æ‰‹æœ­ã«åŠ ãˆã‚‹ã€‚\nãã—ã¦å±±æœ­ã‚’åˆ‡ã‚‹ã€‚",
        "ãŠãŸãŒã„ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã€ãã‚Œãã‚Œæ‰‹æœ­ã‚’ã™ã¹ã¦å±±æœ­ã«ã‚‚ã©ã—ã¦åˆ‡ã‚‹ã€‚\nãã®å¾Œã€ãã‚Œãã‚Œå±±æœ­ã‚’4æšå¼•ãã€‚",
        "ç›¸æ‰‹ã®ãƒã‚±ãƒ¢ãƒ³ã‚’1åŒ¹é¸ã³ã€ãã®ãƒã‚±ãƒ¢ãƒ³ã«ã¤ã„ã¦ã„ã‚‹ã€Œãƒã‚±ãƒ¢ãƒ³ã®ã©ã†ãã€ã¨ã€Œç‰¹æ®Šã‚¨ãƒãƒ«ã‚®ãƒ¼ã€ã‚’1æšãšã¤ãƒˆãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹ã€‚",
        "è‡ªåˆ†ã®å±±æœ­ã‹ã‚‰ãŸã­ãƒã‚±ãƒ¢ãƒ³ã‚’2æšã¾ã§ã€ã¾ãŸã¯é€²åŒ–ãƒã‚±ãƒ¢ãƒ³ã‚’1æšé¸ã³ã€ç›¸æ‰‹ã«è¦‹ã›ã¦ã€æ‰‹æœ­ã«åŠ ãˆã‚‹ã€‚\nãã—ã¦å±±æœ­ã‚’åˆ‡ã‚‹ã€‚",
        "ã“ã®ã‚«ãƒ¼ãƒ‰ã¯ã€å…ˆæ”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æœ€åˆã®ç•ªã§ã‚‚ä½¿ãˆã‚‹ã€‚\n\nè‡ªåˆ†ã®æ‰‹æœ­ã‚’ã™ã¹ã¦ãƒˆãƒ©ãƒƒã‚·ãƒ¥ã—ã€å±±æœ­ã‚’5æšå¼•ãã€‚",
        "è‡ªåˆ†ã®ãƒˆãƒ©ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒã‚±ãƒ¢ãƒ³ï¼ˆã€Œãƒ«ãƒ¼ãƒ«ã‚’æŒã¤ãƒã‚±ãƒ¢ãƒ³ã€ã‚’ã®ããï¼‰ã¨åŸºæœ¬ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’åˆè¨ˆ3æšã¾ã§é¸ã³ã€ç›¸æ‰‹ã«è¦‹ã›ã¦ã€æ‰‹æœ­ã«åŠ ãˆã‚‹ã€‚",
        "è‡ªåˆ†ã®å±±æœ­ã‹ã‚‰ã€ãã‚Œãã‚Œã¡ãŒã†ã‚¿ã‚¤ãƒ—ã®åŸºæœ¬ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’2æšã¾ã§é¸ã³ã€ç›¸æ‰‹ã«è¦‹ã›ã¦ã€ã©ã¡ã‚‰ã‹1æšã‚’æ‰‹æœ­ã«åŠ ãˆã€æ®‹ã‚Šã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’è‡ªåˆ†ã®ãƒã‚±ãƒ¢ãƒ³ã«ã¤ã‘ã‚‹ã€‚\nãã—ã¦å±±æœ­ã‚’åˆ‡ã‚‹ã€‚",
        "è‡ªåˆ†ã®å±±æœ­ã‹ã‚‰ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’1æšãšã¤é¸ã³ã€ç›¸æ‰‹ã«è¦‹ã›ã¦ã€æ‰‹æœ­ã«åŠ ãˆã‚‹ã€‚\nãã—ã¦å±±æœ­ã‚’åˆ‡ã‚‹ã€‚",
        "ã“ã®ã‚«ãƒ¼ãƒ‰ã¯ã€è‡ªåˆ†ã®æ‰‹æœ­ã‚’1æšãƒˆãƒ©ãƒƒã‚·ãƒ¥ã—ãªã‘ã‚Œã°ä½¿ãˆãªã„ã€‚\n\nç›¸æ‰‹ã®ãƒ™ãƒ³ãƒãƒã‚±ãƒ¢ãƒ³ã®æ•°ã¶ã‚“ã€è‡ªåˆ†ã®å±±æœ­ã‚’å¼•ãã€‚"
    ];

    let cardBaseImage = new Image();

    /**
     * çµæœç”»é¢ã®æç”»é–‹å§‹
     */
    function drawResultCard() {
        const cardName     = sessionStorage.getItem('cardName');
        const imageDataURL = sessionStorage.getItem('imageDataURL');

        if (!cardName || !imageDataURL) {
            alert("ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…¥åŠ›ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚");
            window.location.href = 'index.html'; // å…ƒã®ã‚«ãƒ¼ãƒ‰ä½œæˆç”»é¢
            return;
        }

        const uploadedProfileImage = new Image();

        uploadedProfileImage.onload = () => {
            cardBaseImage.onload = () => {
                cardCanvas.width  = cardBaseImage.width;
                cardCanvas.height = cardBaseImage.height;

                renderCard(cardName, uploadedProfileImage);
            };
            cardBaseImage.onerror = () => {
                alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            };
            cardBaseImage.src = TEMPLATE_PATH;
        };

        uploadedProfileImage.src = imageDataURL;
    }

    /**
     * ã‚«ãƒ¼ãƒ‰ã®æç”»ã¨ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³è¨­å®š
     */
    function renderCard(cardName, uploadedProfileImage) {
        // 1. ãƒ™ãƒ¼ã‚¹ç”»åƒæç”»
        ctx.clearRect(0, 0, cardCanvas.width, cardCanvas.height);
        ctx.drawImage(cardBaseImage, 0, 0, cardCanvas.width, cardBaseImage.height);

        // 2. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒåˆæˆ
        ctx.drawImage(
            uploadedProfileImage,
            profileImageX,
            profileImageY,
            profileImageWidth,
            profileImageHeight
        );

        // 3. ã‚«ãƒ¼ãƒ‰å
        if (cardName.trim() !== "") {
            ctx.fillStyle = '#000';
            ctx.font = 'bold 48px "Mplus1-Bold", sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(cardName, 80, NAME_Y);
        }

        // 4. ãƒ©ãƒ³ãƒ€ãƒ åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆ
        const randomIndex      = Math.floor(Math.random() * EFFECT_PATTERNS.length);
        const randomEffectText = EFFECT_PATTERNS[randomIndex];

        ctx.fillStyle = '#000';
        ctx.font      = '18px sans-serif';
        ctx.textAlign = 'left';

        wrapText(
            ctx,
            randomEffectText,
            EFFECT_X,
            EFFECT_Y_START,
            EFFECT_MAX_WIDTH,
            EFFECT_LINE_HEIGHT
        );

        // 5. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯æ›´æ–°
        const dataURL = cardCanvas.toDataURL('image/png');
        downloadLink.href = dataURL;

        // 6. ã‚µãƒ¼ãƒãƒ¼ã«ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ URLå–å¾— â†’ ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³è¨­å®š
        uploadImageToServer(dataURL)
            .then(imageUrl => {
                console.log('Uploaded image URL:', imageUrl);
                setupShareButton(cardName, randomEffectText, imageUrl);
            })
            .catch(err => {
                console.error('Upload failed:', err);
                // ç”»åƒURLãªã—ã§ã‚‚ãƒ†ã‚­ã‚¹ãƒˆã ã‘ã§ã‚·ã‚§ã‚¢ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                setupShareButton(cardName, randomEffectText, null);
            });
    }

    /**
     * ç”»åƒã‚’ ConoHa ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ URL ã‚’è¿”ã™
     */
    async function uploadImageToServer(dataURL) {
    const response = await fetch('https://gun-lido.com/cards/upload_card.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: dataURL })
    });
    const result = await response.json();
    console.log("ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœ:", result);

    if (result.url) {
        return result.url; // â† ç”»åƒURLã‚’è¿”ã™
    } else {
        throw new Error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: URLæœªè¿”å´');
    }
}


    /**
     * XæŠ•ç¨¿ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
     */
    function setupShareButton(cardName, effectText, imageUrl) {
    shareButton.onclick = () => {

        const appURL = 'https://fever39risky-ux.github.io/card-maker-app/';

        const shareText =
            `ğŸ‰ ãƒã‚±ã‚«é¢¨ã®ã‚µãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ãŒç°¡å˜ã«ä½œã‚Œã¡ã‚ƒã†ï¼ï¼\n` +
            `${baseName}ãŒã‚µãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ã«ãªã£ãŸã‚‰ï¼Ÿ\n\n` +
            `ã€ ã‚«ãƒ¼ãƒ‰å: ${cardName} ã€\n` +
            (imageUrl ? `ğŸ–¼ ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’ã¿ã¦ã¿ã‚‹ğŸ‘‡\n${imageUrl}\n\n` : ``) +
            `ğŸ”½ ã‚ãªãŸã‚‚ä½œã‚‹ ğŸ”½\n${appURL}\n\n` +
            `#ãƒã‚±ã‚«é¢¨ã‚µãƒãƒ¼ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼`;

        window.open(
            `https://x.com/intent/post?text=${encodeURIComponent(shareText)}`,
            '_blank'
        );
    };
}

    /**
     * ãƒ†ã‚­ã‚¹ãƒˆã‚’æœ€å¤§å¹…ã«åˆã‚ã›ã¦è‡ªå‹•æ”¹è¡Œ
     */
    function wrapText(context, text, x, y, maxWidth, lineHeight) {
        const chars = text.split('');
        let line    = '';
        let currentY = y;

        for (let i = 0; i < chars.length; i++) {
            const char = chars[i];

            if (char === '\n') {
                context.fillText(line, x, currentY);
                line = '';
                currentY += lineHeight;
                continue;
            }

            const testLine  = line + char;
            const testWidth = context.measureText(testLine).width;

            if (testWidth > maxWidth) {
                context.fillText(line, x, currentY);
                line = char;
                currentY += lineHeight;
            } else {
                line = testLine;
            }
        }
        context.fillText(line, x, currentY);
    }

    /**
     * æˆ»ã£ã¦ä½œã‚Šç›´ã™
     */
    function clearAndGoBack() {
        sessionStorage.removeItem('cardName');
        sessionStorage.removeItem('imageDataURL');
        window.location.href = 'index.html'; // ã‚«ãƒ¼ãƒ‰ä½œæˆç”»é¢ï¼ˆindex.html ã«ã—ã¦ã„ã‚‹å‰æï¼‰
    }
</script>

</body>
</html>














